{% extends "layout.html" %}

{% block head_extra %}
<style>
.modal { display: none; position: fixed; top: 0; left: 0; right:0; bottom:0; background: rgba(0,0,0,0.6); }
.modal-content { background:#001a33; margin:10% auto; padding:1rem; width:300px; color:#fff; }
</style>
{% endblock %}

{% block content %}
<div class="synthesis-container">
    <h2>モンスター合成</h2>
    <p id="result-msg">{% if message %}{{ message }}{% else %}合成するモンスターを選択してください{% endif %}</p>
    <button id="open-modal">合成を開始</button>

    <div id="synth-modal" class="modal">
        <div class="modal-content">
            <label for="base-type">ベースタイプ</label>
            <select id="base-type">
                <option value="monster">モンスター</option>
                <option value="item">アイテム</option>
            </select>
            <div id="base-monster">
                <label for="base-select">モンスター</label>
                <select id="base-select">
                    {% for m in player.party_monsters %}
                    <option value="{{ loop.index0 }}">{{ m.name }} Lv.{{ m.level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="base-item" style="display:none;">
                <label for="base-item-select">アイテム</label>
                <select id="base-item-select">
                    {% for it in player.items %}
                    <option value="{{ it.item_id }}">{{ it.name }}</option>
                    {% endfor %}
                    {% for eq in player.equipment_inventory %}
                    <option value="{{ eq.base_item.equip_id if hasattr(eq,'base_item') else eq.equip_id }}">{{ eq.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <br>
            <label for="mat-type">素材タイプ</label>
            <select id="mat-type">
                <option value="monster">モンスター</option>
                <option value="item">アイテム</option>
            </select>
            <div id="mat-monster">
                <label for="monster-select">モンスター</label>
                <select id="monster-select">
                    {% for m in player.party_monsters %}
                    <option value="{{ loop.index0 }}">{{ m.name }} Lv.{{ m.level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="mat-item" style="display:none;">
                <label for="item-select">アイテム</label>
                <select id="item-select">
                    {% for it in player.items %}
                    <option value="{{ it.item_id }}">{{ it.name }}</option>
                    {% endfor %}
                    {% for eq in player.equipment_inventory %}
                    <option value="{{ eq.base_item.equip_id if hasattr(eq,'base_item') else eq.equip_id }}">{{ eq.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button id="do-synth">合成</button>
            <button id="close-modal">閉じる</button>
        </div>
    </div>
    <a href="{{ url_for('play', user_id=user_id) }}">戻る</a>
</div>
{% endblock %}

{% block scripts %}
<script>
const modal = document.getElementById('synth-modal');
const openBtn = document.getElementById('open-modal');
const closeBtn = document.getElementById('close-modal');
const matTypeSel = document.getElementById('mat-type');
const matMonster = document.getElementById('mat-monster');
const matItem = document.getElementById('mat-item');
const baseTypeSel = document.getElementById('base-type');
const baseMonster = document.getElementById('base-monster');
const baseItem = document.getElementById('base-item');
openBtn.addEventListener('click', () => { modal.style.display = 'block'; });
closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        modal.style.display = 'none';
    }
});
matTypeSel.addEventListener('change', () => {
    if (matTypeSel.value === 'item') { matItem.style.display = 'block'; matMonster.style.display = 'none'; }
    else { matItem.style.display = 'none'; matMonster.style.display = 'block'; }
});
baseTypeSel.addEventListener('change', () => {
    if (baseTypeSel.value === 'item') { baseItem.style.display = 'block'; baseMonster.style.display = 'none'; }
    else { baseItem.style.display = 'none'; baseMonster.style.display = 'block'; }
});
const doBtn = document.getElementById('do-synth');
const resultMsg = document.getElementById('result-msg');
doBtn.addEventListener('click', () => {
    const payload = {
        base_type: baseTypeSel.value,
        base_id: baseTypeSel.value === 'item' ? document.getElementById('base-item-select').value : parseInt(document.getElementById('base-select').value),
        material_type: matTypeSel.value,
        material_id: matTypeSel.value === 'item' ? document.getElementById('item-select').value : parseInt(document.getElementById('monster-select').value)
    };
    fetch("{{ url_for('synthesize_action', user_id=user_id) }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(r=>r.json()).then(data=>{
        if(data.success){
            const msg = data.result_type === 'monster' ? data.name + ' が誕生した！' : data.name + ' を入手した！';
            resultMsg.textContent = msg;
            setTimeout(()=>{ window.location.reload(); }, 1000);
        } else {
            resultMsg.textContent = data.error || '失敗';
        }
    }).catch(()=>{ resultMsg.textContent = '通信エラー';});
    modal.style.display='none';
});
</script>
{% endblock %}
